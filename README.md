# Таблица (Spreadsheet)

## Описание проекта

**Таблица (Spreadsheet)** — это проект на C++, реализующий функциональность электронной таблицы, аналогичной Microsoft Excel или Google Sheets. Программа позволяет задавать содержимое ячеек, вычислять арифметические выражения, обрабатывать ссылки на другие ячейки и управлять ошибками, такими как деление на ноль, некорректные ссылки или циклические зависимости. Проект использует ANTLR для парсинга формул и предоставляет следующие возможности:

- Ввод текстовых данных и формул в ячейки.
- Поддержка арифметических операций: сложение, вычитание, умножение, деление.
- Обработка ссылок на ячейки (например, `A1`, `B2`) с автоматическим обновлением при изменении значений.
- Проверка циклических зависимостей между ячейками.
- Динамическое управление размером таблицы и вывод её содержимого в текстовом формате.
- Обработка ошибок: `#REF!` (некорректная ссылка), `#VALUE!` (нечисловые значения), `#ARITHM!` (арифметические ошибки, например, деление на ноль).

Проект включает модульное тестирование с использованием пользовательского фреймворка `TestRunner` для проверки корректности работы всех компонентов.

## Технические особенности

- **Язык и стандарт**: Проект написан на C++ с использованием стандарта C++17, обеспечивающего современные возможности языка, такие как `std::variant` для представления значений ячеек и `std::optional` для кэширования.
- **ANTLR для парсинга**: Формулы обрабатываются с использованием ANTLR 4.13.2, который генерирует лексер и парсер на основе грамматики `Formula.g4`. Это позволяет эффективно разбирать сложные выражения, такие как `(2+3)*4`, с учётом приоритетов операторов.
- **Абстрактное синтаксическое дерево (AST)**: Формулы преобразуются в AST (`FormulaAST.cpp`) для оптимизированной обработки и вычисления. Реализация использует рекурсивный спуск для построения дерева и его обхода при вычислении выражений.
- **Алгоритм проверки циклических зависимостей**: Для предотвращения бесконечных циклов в формулах реализован алгоритм поиска в глубину (Depth-First Search, DFS) в методе `Cell::CheckCyclicDependency`. Он отслеживает посещенные ячейки и текущий стек вызовов, используя `std::unordered_set` для эффективного поиска.
- **Паттерн Стратегия (Strategy)**: Класс `Cell` использует паттерн Стратегия через абстрактный базовый класс `Impl` и его реализации (`EmptyImpl`, `TextImpl`, `FormulaImpl`). Это позволяет динамически переключать поведение ячейки (пустая, текстовая, формульная) без изменения основного кода.
- **Кэширование**: Значения формул кэшируются в `Cell::cache_` с использованием `std::optional`. Кэш очищается рекурсивно при изменении зависимых ячеек (`ClearCache`), что минимизирует повторные вычисления.
- **Управление зависимостями**: Реализован граф зависимостей между ячейками с помощью множеств `parents_` и `children_` в классе `Cell`. Метод `RefreshParents` эффективно обновляет связи, используя операции над множествами.
- **Обработка ошибок**: Система поддерживает три типа ошибок (`Ref`, `Value`, `Arithmetic`) с чётким отображением в виде строк (`#REF!`, `#VALUE!`, `#ARITHM!`), реализованных через класс `FormulaError`.
- **Тестирование**: Встроенный фреймворк `TestRunner` обеспечивает тестирование всех ключевых функций, включая преобразование координат, вычисление формул и обработку ошибок, с использованием макросов `ASSERT` и `ASSERT_EQUAL`.

## Возможные доработки

Для расширения функциональности и повышения производительности программы можно реализовать следующие улучшения:

- **Консольный интерфейс**:

  - Добавить интерактивный консольный интерфейс для ввода данных в ячейки, просмотра содержимого таблицы и выполнения команд (например, `SET A1 =42`, `PRINT VALUES`, `CLEAR B2`)
  - Поддержка автодополнения для адресов ячеек и формул, что упростит взаимодействие с программой.

- **Сохранение данных в PostgreSQL**:

  - Интеграция с СУБД PostgreSQL для сохранения содержимого таблицы (ячеек, формул и их значений) в базе данных.
  - Создание таблицы `cells` с полями для позиции (`row`, `col`), текста (`text`) и кэшированного значения (`value`).
  - Реализация функций для загрузки и сохранения состояния таблицы с использованием библиотеки `libpqxx` для работы с PostgreSQL.
  - Поддержка транзакций для обеспечения целостности данных при массовых обновлениях ячеек.

- **Оптимизация производительности**:

  - **Ленивое вычисление формул**: Реализовать механизм отложенного вычисления, при котором формулы пересчитываются только при обращении к их значениям или при изменении зависимых ячеек. Это снизит нагрузку при работе с большими таблицами.
  - **Инкрементальное обновление зависимостей**: Оптимизировать алгоритм `ClearCache` и `RefreshParents`, используя направленный ациклический граф (DAG) для минимизации числа пересчётов.
  - **Параллельное вычисление**: Для таблиц с большим количеством формул реализовать многопоточную обработку независимых ячеек с использованием `std::thread` или `std::async`, обеспечив потокобезопасность при доступе к `Sheet`.

- **Оптимизация использования памяти**:

  - **Сжатие таблицы**: Заменить `std::vector<std::vector<std::unique_ptr<Cell>>>` в `Sheet` на разреженную структуру данных, например, `std::unordered_map<Position, std::unique_ptr<Cell>>`, чтобы хранить только непустые ячейки. Это значительно сократит потребление памяти для больших таблиц с малым количеством заполненных ячеек.
  - **Очистка неиспользуемых ячеек**: Реализовать периодическую сборку мусора для удаления объектов `Cell` с пустым содержимым, не связанным с другими ячейками.
  - **Оптимизация хранения формул**: Хранить AST формул в компактном виде, используя пул памяти для повторяющихся узлов, чтобы уменьшить накладные расходы на дублирование выражений.

- **Расширение функциональности формул**:

  - Добавить поддержку встроенных функций, таких как `SUM`, `AVERAGE`, `IF`, с обновлением грамматики `Formula.g4` и логики парсинга в `FormulaAST`.
  - Реализовать обработку диапазонов ячеек (например, `A1:A10`) для массовых операций.
  - Поддержка строковых операций в формулах, таких как конкатенация или поиск подстроки.

- **Логирование и отладка**:

  - Внедрить систему логирования с использованием библиотеки, например, `spdlog`, для отслеживания операций с ячейками и ошибок.
  - Добавить возможность экспорта графа зависимостей в формате DOT для визуализации с помощью Graphviz.

## Требования

Для сборки и запуска проекта необходимы следующие инструменты:

- **Компилятор C++**: Поддерживающий стандарт C++17 (например, GCC, Clang, MSVC).
- **CMake**: Версия 3.8 или выше для сборки проекта.
- **Java Runtime Environment (JRE)**: Для работы ANTLR (генерация парсера формул).
- **ANTLR 4.13.2**: Файл `antlr-4.13.2-complete.jar` включён в репозиторий.
- **Операционная система**: Протестировано на Windows, Linux и macOS.

## Установка

1. **Клонируйте репозиторий**:

   ```bash
   git clone https://github.com/username/spreadsheet.git
   cd spreadsheet
   ```

2. **Создайте директорию для сборки**:

   ```bash
   mkdir build
   cd build
   ```

3. **Сконфигурируйте проект с помощью CMake**:

   ```bash
   cmake ..
   ```

4. **Соберите проект**:

   ```bash
   cmake --build .
   ```

5. **Запустите программу**: Исполняемый файл `spreadsheet` будет находиться в папке `build`. Для запуска выполните:

   ```bash
   ./spreadsheet
   ```

## Структура проекта

- `Formula.g4`: Грамматика ANTLR для парсинга формул.
- `FormulaAST.cpp/h`: Реализация Abstract Syntax Tree (AST) для вычисления формул.
- `formula.cpp/h`: Класс `Formula`, реализующий интерфейс `FormulaInterface` для работы с формулами.
- `cell.cpp/h`: Класс `Cell`, реализующий ячейки таблицы с поддержкой текста, формул и кэширования.
- `sheet.cpp/h`: Класс `Sheet`, управляющий таблицей, её размером и содержимым.
- `structures.cpp/h`: Определение структур `Position` и `Size` для работы с координатами и размерами таблицы.
- `common.h`: Общие определения, константы и интерфейсы.
- `test_runner_p.h`: Фреймворк для модульного тестирования.
- `main.cpp`: Тестовые сценарии для проверки функциональности.
- `FindANTLR.cmake`: CMake-скрипт для интеграции ANTLR.
- `CMakeLists.txt`: Конфигурация сборки проекта.

## Использование

Программа предоставляет интерфейс для работы с таблицей через код. Основные возможности:

- **Задание содержимого ячейки**:

  ```cpp
  auto sheet = CreateSheet();
  sheet->SetCell(Position{0, 0}, "42"); // Устанавливает значение 42 в ячейку A1
  sheet->SetCell(Position{1, 1}, "=A1+10"); // Формула в ячейке B2
  ```

- **Получение значения ячейки**:

  ```cpp
  auto cell = sheet->GetCell(Position{1, 1});
  std::cout << cell->GetValue() << std::endl; // Вывод: 52
  ```

- **Вывод таблицы**:

  ```cpp
  sheet->PrintValues(std::cout); // Вывод значений ячеек
  sheet->PrintTexts(std::cout); // Вывод текстового содержимого ячеек
  ```

- **Обработка ошибок**: Программа корректно обрабатывает ошибки, такие как деление на ноль (`#ARITHM!`), некорректные ссылки (`#REF!`) и неверные значения (`#VALUE!`).

## Тестирование

Проект включает набор тестов, проверяющих корректность работы всех компонентов:

- Преобразование координат ячеек (`TestPositionAndStringConversion`).
- Обработка некорректных позиций (`TestInvalidPosition`).
- Работа с текстовыми ячейками (`TestSetCellPlainText`).
- Вычисление арифметических формул (`TestFormulaArithmetic`).
- Обработка ссылок на ячейки (`TestFormulaReferences`).
- Проверка циклических зависимостей (`TestCellCircularReferences`).

Для запуска тестов выполните собранный исполняемый файл:

```bash
./spreadsheet
```

## Примечания

- **ANTLR**: Убедитесь, что файл `antlr-4.13.2-complete.jar` находится в корне проекта, так как он необходим для генерации парсера формул.
- **Ограничения**: Таблица ограничена размерами `16384x16384` (максимальные значения для строк и столбцов).
- **Кэширование**: Значения формул кэшируются для оптимизации производительности. При изменении зависимых ячеек кэш автоматически очищается.
